<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MASTER Viewer</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    button { margin-right: 8px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
</head>
<body>
  <h2>MASTER Viewer (GitHub Pages)</h2>

  <button id="btnSignIn">Sign in</button>
  <button id="btnLoad" disabled>Load latest 1000</button>
  <button id="btnLoadAll" disabled>Load ALL (paged)</button>

  <pre id="out">Not signed in.</pre>

<script>
const CLIENT_ID = "2917063777-uqufm9ksouql514j7rp61hddvjgece6u.apps.googleusercontent.com";
const SCRIPT_ID  = "1RjqH74IuRM6arv_N10xKEbKXIgAbp3HwOp2B-kbyqmgYX8xE7FllNP28";

let accessToken = null;
let tokenClient = null;

function log(obj) {
  document.getElementById("out").textContent = JSON.stringify(obj, null, 2);
}

async function callScriptsRun(functionName, paramsObj) {
  const payload = {
    function: functionName,
    parameters: [paramsObj]
  };

  const res = await fetch(`https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (json.error) throw new Error(JSON.stringify(json.error, null, 2));
  return json.response.result;
}

async function loadLatest() {
  const result = await callScriptsRun("apiGet", { limit: 1000, offset: 0, order: "desc" });
  log(result);
}

async function loadAllPaged() {
  const pageSize = 5000;
  let offset = 0;
  let all = [];
  let meta = null;

  while (true) {
    const r = await callScriptsRun("apiGet", { limit: pageSize, offset, order: "desc" });
    meta = r.meta;
    all = all.concat(r.data);

    if (!r.data || r.data.length === 0) break;
    offset += r.data.length;
    if (meta && offset >= meta.total) break;

    // กันไม่ให้ค้างในกรณี meta.total ไม่ถูก (safety)
    if (offset > 500000) break;
  }

  log({ ok: true, meta, totalLoaded: all.length, data: all });
}

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: [
      "openid",
      "email",
      "https://www.googleapis.com/auth/script.projects"
    ].join(" "),
    callback: (resp) => {
      if (resp.error) return log(resp);
      accessToken = resp.access_token;
      document.getElementById("btnLoad").disabled = false;
      document.getElementById("btnLoadAll").disabled = false;
      log({ ok: true, signedIn: true });
    }
  });

  document.getElementById("btnSignIn").onclick = () => {
    tokenClient.requestAccessToken({ prompt: "" });
  };

  document.getElementById("btnLoad").onclick = async () => {
    try { await loadLatest(); }
    catch (e) { log({ ok: false, error: String(e) }); }
  };

  document.getElementById("btnLoadAll").onclick = async () => {
    try { await loadAllPaged(); }
    catch (e) { log({ ok: false, error: String(e) }); }
  };
};
</script>
</body>
</html>
