<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MASTER Viewer</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    button { margin-right: 8px; margin-bottom: 10px; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }

    .table-wrap { margin-top: 14px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 10px; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { position: sticky; top: 0; background: #fff; z-index: 1; border-bottom: 1px solid #ddd; }
    tr:hover td { background: #fafafa; }

    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .toolbar input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; min-width: 260px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
  </style>
</head>
<body>
  <h2>MASTER Viewer (GitHub Pages)</h2>

  <div class="toolbar">
    <button id="btnSignIn">Sign in</button>

    <button id="btnShowLatest" disabled>Show table (latest 1000)</button>
    <button id="btnShowAll" disabled>Show table (ALL paged)</button>

    <input id="q" disabled placeholder="Filter (contains)…" />
    <span id="meta" class="pill">Not signed in</span>
  </div>

  <div class="muted">
    Tip: ถ้าข้อมูลเยอะมาก แนะนำใช้ latest/paged + filter แทนการโหลดทั้งหมดในครั้งเดียว
  </div>

  <div id="tableContainer" class="table-wrap" style="display:none;"></div>

  <pre id="out">Not signed in.</pre>

<script>
const CLIENT_ID = "2917063777-uqufm9ksouql514j7rp61hddvjgece6u.apps.googleusercontent.com";
const SCRIPT_ID = "1RjqH74IuRM6arv_N10xKEbKXIgAbp3HwOp2B-kbyqmgYX8xE7FllNP28";

let accessToken = null;
let tokenClient = null;

// cache ล่าสุดที่โหลด เพื่อ filter ได้ทันทีโดยไม่ต้องยิง API ซ้ำ
let lastLoadedRows = [];
let lastLoadedHeaders = [];

function log(obj) {
  document.getElementById("out").textContent = JSON.stringify(obj, null, 2);
}

function setMeta(text) {
  document.getElementById("meta").textContent = text;
}

async function callScriptsRun(functionName, paramsObj) {
  const payload = {
    function: functionName,
    parameters: [paramsObj]
  };
  const res = await fetch(`https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });
  
  const json = await res.json();
  if (json.error) throw new Error(JSON.stringify(json.error, null, 2));
  return json.response.result;
}

function normalizeCell(v) {
  // Apps Script Date มักถูก serialize เป็น string; บางกรณีอาจเป็น object
  if (v === null || v === undefined) return "";
  if (typeof v === "string") return v;
  if (typeof v === "number" || typeof v === "boolean") return String(v);
  // fallback
  try { return JSON.stringify(v); } catch { return String(v); }
}

function buildHeadersFromRows(rows) {
  if (!rows || rows.length === 0) return [];
  // apiGet() คืนเป็น array ของ object (key=header)
  return Object.keys(rows[0]);
}

function renderTable(rows) {
  const container = document.getElementById("tableContainer");
  if (!rows || rows.length === 0) {
    container.style.display = "block";
    container.innerHTML = `<div style="padding:12px;">No data</div>`;
    return;
  }

  const headers = buildHeadersFromRows(rows);
  lastLoadedRows = rows;
  lastLoadedHeaders = headers;

  const thead = `
    <thead>
      <tr>
        ${headers.map(h => `<th>${escapeHtml(h)}</th>`).join("")}
      </tr>
    </thead>
  `;

  const tbody = `
    <tbody>
      ${rows.map(r => `
        <tr>
          ${headers.map(h => `<td>${escapeHtml(normalizeCell(r[h]))}</td>`).join("")}
        </tr>
      `).join("")}
    </tbody>
  `;

  container.innerHTML = `<table>${thead}${tbody}</table>`;
  container.style.display = "block";
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function applyFilter() {
  const q = document.getElementById("q").value.trim().toLowerCase();
  if (!q) {
    renderTable(lastLoadedRows);
    setMeta(`rows: ${lastLoadedRows.length} (no filter)`);
    return;
  }

  const filtered = lastLoadedRows.filter(row => {
    // simple contains search across all cells
    for (const h of lastLoadedHeaders) {
      const v = normalizeCell(row[h]).toLowerCase();
      if (v.includes(q)) return true;
    }
    return false;
  });

  renderTable(filtered);
  setMeta(`rows: ${filtered.length} / ${lastLoadedRows.length} (filtered)`);
}

async function showLatestTable() {
  setMeta("Loading latest…");
  const result = await callScriptsRun("apiGet", { limit: 1000, offset: 0, order: "desc" });

  // result = { ok, meta, data: [...] }
  renderTable(result.data || []);
  document.getElementById("q").disabled = false;
  setMeta(`rows: ${(result.data || []).length} / total: ${result.meta?.total ?? "?"}`);
  log(result);
}

async function showAllPagedTable() {
  setMeta("Loading ALL paged…");
  const pageSize = 5000;
  let offset = 0;
  let all = [];
  let meta = null;

  while (true) {
    const r = await callScriptsRun("apiGet", { limit: pageSize, offset, order: "desc" });
    meta = r.meta;

    const chunk = r.data || [];
    all = all.concat(chunk);

    if (chunk.length === 0) break;
    offset += chunk.length;
    if (meta && offset >= meta.total) break;

    // safety guard
    if (offset > 500000) break;
  }

  renderTable(all);
  document.getElementById("q").disabled = false;
  setMeta(`rows: ${all.length} / total: ${meta?.total ?? "?"}`);
  log({ ok: true, meta, totalLoaded: all.length });
}

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: [
      "openid",
      "email",
      "https://www.googleapis.com/auth/script.projects"
    ].join(" "),
    callback: (resp) => {
      if (resp.error) return log(resp);
      accessToken = resp.access_token;

      document.getElementById("btnShowLatest").disabled = false;
      document.getElementById("btnShowAll").disabled = false;
      document.getElementById("q").disabled = false;

      setMeta("Signed in");
      log({ ok: true, signedIn: true });
    }
  });

  document.getElementById("btnSignIn").onclick = () => {
    tokenClient.requestAccessToken({ prompt: "" });
  };

  document.getElementById("btnShowLatest").onclick = async () => {
    try { await showLatestTable(); }
    catch (e) { log({ ok: false, error: String(e) }); setMeta("Error"); }
  };

  document.getElementById("btnShowAll").onclick = async () => {
    try { await showAllPagedTable(); }
    catch (e) { log({ ok: false, error: String(e) }); setMeta("Error"); }
  };

  document.getElementById("q").addEventListener("input", () => {
    // ถ้ายังไม่ได้โหลดข้อมูล จะไม่ทำอะไร
    if (!lastLoadedRows || lastLoadedRows.length === 0) return;
    applyFilter();
  });
};
</script>
</body>
</html>
